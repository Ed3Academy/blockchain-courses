# 📊盲拍出价

## **🚧 教学目标**

1. 了解ABI编码
2. 了解哈希函数
3. 了解和掌握结构体
4. 了解和掌握定长字节数组
 

## **💚 任务描述**

传统的公开竞拍方式，让竞标者直接公开他们的出价，这种方式会导致有些竞标者会根据其他竞标者的出价进行调整，从而影响竞价决策，造成不公平竞争，因此在本任务中我们引入了盲拍的方式，盲拍在竞拍期间不公开实际出价，使用加密或哈希值代替，从而保护出价隐私，提供公平竞争的环境。  

盲拍的规则如下：
1. 出价哈希化，竞拍者将他们的出价通过哈希函数进行哈希化，生成一个不可逆的哈希值。
2. 哈希值的生成规则，竞拍者选择一个出价，附加一个是否伪拍标记组合一起通过哈希函数生成哈希值。
3. 竞标者携带哈希值和预存以太币参与竞拍，以太币在区块链上公开的，可以用于迷惑对手
4. 竞拍披露时，选择竞标者真拍的竞拍去披露，如果披露价低于当次预存的以太币，认为该竞拍失败。
5. 只有在出价披露阶段被正确披露，已发送的以太币才会被退还。  

本任务目标：
1. 声明一个结构体类型关联竞拍者的哈希值和以太币
2. 声明一个映射类型，映射关系为当前账户和多次出价的信息  
3. 编写出价方法，将当次出价的信息映射到当前账户 
 

## **⚡ 相关知识**
知识点简述，（后续会替换AI课件，可以先参看AI脚本：）  
[AI课件](https://docs.qq.com/sheet/DSmdHWWNoT25LTENl?tab=qpst6z)  
   

## **✨ 任务关键步骤分析**
1. 声明一个结构体，结构体成员包含出价哈希值和预存到账户的以太币
2. 声明一个映射类型，进行出价账户和出价信息的映射 
3. 编写出价方法，将当次出价的信息映射到当前账户

## **✨ 任务疑难点分析**
1. 如何进行出价哈希
解析：访问https://playground.ethers.org/，这是一个在线的Ethereum Playground，提供了一个交互式的环境，让用户可以在浏览器中直接运行和测试以太坊智能合约和Ethers.js代码。
```JavaScript
    ethers.utils.keccak256(
    ethers.utils.defaultAbiCoder.encode(["uint256", "bool", "string"],
    [1, true, "abc"]),
  );
```   
示例中，通过调用ethers.js中defaultAbiCoder对象方法encode将出价信息转换为ABI编码，再通过keccak256将ABI编码通过哈希计算生成哈希值。  
其中三个参数分别为：
a. 竞拍出价，数据类型uint256
b. 是否是伪出价，true：伪出价，false：真实出价，数据类型为bool
c. 随意值，数据类型自定义，示例中为字符串类型

2、为什么需要声明一个结构体，结构体成员包含出价哈希值和预存到账户的以太币
解析：竞拍者出价信息包含出价哈希和预存以太币，这两个数据信息用于描述竞拍者出价信息，因此为这两个相关的数据信息声明一个结构体类型，让合约代码更加模块化。其中，哈希值需要用定长字节数组bytes32类型定义。
```Solidity
//示例：定义一个名为Account的结构体，包含账户的持有人、余额和账户类型
    struct Account {
        address owner;
        uint balance;
        string accountType;
    }
```  
其中持有人，余额和账户类型均是该账户的相关信息，因此定义一个结构体类型来声明该数据结构。定义好结构体后，在函数体中如何访问？
```Solidity
accounts[msg.sender] = Account({owner: msg.sender, balance: 0,
accountType: accountType});
```  

3、如何让一个映射类型，实施账户和多次出价信息的映射
解析：
```Solidity
    // 定义一个映射，将账户地址映射到其多次出价信息
    mappint(address => uint[])  public bids;
    // 用户进行出价
    function placeBid(uint bidAmount) public {
        // 将出价信息存储到映射中
        bids[msg.sender].push(bidAmount);
    }  
```  


## **✨ 任务实现**
1. **完善合约**  
    根据步骤提示，完善右侧合约文件中begin...end之间的代码。

3. **合约测试**  
   a. 编译和部署合约   

   b. 设定投标受益人，投标时长为60s

   c. 用户A在拍卖截止时间前投标10 Wei，交易成功，查看相应的状态变量，最高竞拍者信息记录为用户A，竞拍价为10

   d. 用户A在拍卖截止时间前结束拍卖，抛出异常，中断结束拍卖； 

   e. 拍卖截止用户A投标10 Wei，抛出异常，交易回滚； 

   f. 拍卖截止用户A结束拍卖，交易成功，收益人B余额增加10 Wei，查看受益人B的账户是否有10 Wei

   

至此，完成了任务43合约的调试，部署和测试。
## **🌸 知识测试**  