# 📊披露盲拍出价

## **🚧 教学目标**

1. 了解变量的存储位置
2. 了解如何输出调试信息
3. 了解和掌握循环结构(for,while,do...while)
4. 了解和掌握continue关键字
5. 了解和掌握事件Event

## **💚 任务描述**

竞拍者采用盲拍的方式参与竞拍，将出价哈希携带预存的以太币一起出价。当竞拍结束后，竞拍者披露在盲拍阶段提交的出价，披露的原则如下：

盲拍的规则如下：
1. 用户A出了2次盲拍，分别为 [1e18, true, "abc"]， [2e18, false, "abc"]
2. 用户A披露盲拍，传入历史竞拍 [1e18, true, "abc"]， [2e18, false, "abc"]
3. 计算用户传入的第一组数据的哈希值与用户的第一次竞拍出价的哈希值是否匹配，如果匹配，披露成功，将当次出价的以太币累计到返还订金。否则披露失败，用户丢失返还定金。
4. 判断本次披露的竞拍是否真拍且是否为最高竞拍，如果是真拍，且是最高竞拍者则从返回定金中去掉本次竞拍价。
5. 用户A披露本次竞拍后，需要将其之前的竞拍哈希值设置为0，避免再次认领同一笔定金
6. 披露所有的竞拍后，将返回金额退还给用户A

本任务目标：
1. 竞拍者一一披露自己的竞拍
2. 判断竞拍者披露的竞拍价与之前的出价是否一致
3. 判断竞拍者真拍的竞拍价是否是最高竞拍
4. 将最高的竞拍价转给受益人
 

## **⚡ 相关知识**
知识点简述，（后续会替换AI课件，可以先参看AI脚本：）  
[AI课件](https://docs.qq.com/sheet/DSmdHWWNoT25LTENl?tab=z32x08)  
   

## **✨ 任务关键步骤分析**
1. 构造函数，新增披露时长，披露时间戳等于竞拍结束时间加披露时长  
2. 新增披露函数，要求调用必须在盲拍结束时间之后，且在披露结束时间之前 
3. 披露函数接受三个数组参数：values、fakes和secrets，分别存储用户在盲拍阶段提交的出价数值、是否为无效出价的标志，以及用于披露的秘密信息。
4. 披露函数检查传入的参数数组长度是否与用户在盲拍阶段提交的出价数量相等。  
5. 披露函数遍历用户在盲拍阶段提交的每个出价，对每个出价进行披露检查。  
6. 对于正确披露的出价，会将对应的订金退还给用户，并处理真正用于招标的金额。对于未正确披露的出价，不会返还订金，用户的盲拍将视为无效。
7. 如果本次竞拍为真拍且预存订金大于等于竞拍价，认定该次竞拍为用户真正用于招标的金额，判断该金额是不是竞拍最高价，如果是则从返回金额中把竞拍出价扣除  
8. 设置盲拍信息中当次的竞拍出价为0，避免再次认领同一笔定金  
8. 将定金返回给竞拍者  
9. 向区块链发出通知有用户进行了披露操作

## **✨ 任务疑难点分析**
1. 如何对竞拍者披露的招标历史计算哈希  
解析：使用solidity内置的哈希函数keccak256
```Solidity
    keccak256(abi.code(value,fake,secte)); 
```   
示例中，通过调用keccak256函数， 
其中三个参数分别为：
a. 竞拍出价
b. 是否是伪出价，true：伪出价，false：真实出价
c. 随意值，数据类型自定义，示例中为字符串类型

2. 如何将历史竞拍数据和盲拍信息进行一一比较  
解析：分别定义三个数组，一个用于存储历史出价value[]，一个用于存储是否伪拍fake[]，一个用于存储密钥secret[]
而竞拍数据在映射类型bids[msg.sender]数据中,  其中每个竞拍者对应的竞拍信息是一个结构体，结构体成员为竞拍价和预存订金
```Solidity
//示例：将用户传入的历史竞拍数据和他的盲拍数据进行验证。
   bidHash =  keccak256(abi.code(value[i],fake[i],secret[i]));
   bidHash == bids[msg.sender][i].blindedBid
   if(bidHash  == keccak256(abi.code(value[i],fake[i],secte[i]));)  //如果验证成功，披露成功
```  
3. 如何向区块链发出通知有用户进行了披露操作  
解析：如果要将相关信息传递给区块链上的监听器，可以先声明event，再通过emit触发事件，发出通知。
```Solidity
event AutionEnded( )  // 声明一个竞拍结束时间
emit  AutionEnded()   // 当竞拍结束合约方法执行完后，触发事件，向区块链发出通知竞拍已经结束。
```  
## **✨ 任务实现**
1. **完善合约**  
    根据步骤提示，完善右侧合约文件中begin...end之间的代码。  

3. **合约测试**  
   a. 编译和部署合约     

   b. 用户A出价100000Wei，伪出价为真(假拍 标记为true),密钥为‘testabc’为其生成哈希值  
   ![call_function.png](https://i.postimg.cc/PxVyRKdF/1.png)
   
   c. 将生成的哈希值传递给bid的参数，选择用户A，预存金额200000Wei，执行盲拍方法  
   ![call_function.png](https://i.postimg.cc/bwvQKkF7/2.png)

   d. 查看映射变量bids，是否完成账户和盲拍信息的映射。复制用户A地址，粘贴到bids的参数中，指定索引为0，意味查看用户A，第0个索引的数组值

   ![call_function.png](https://i.postimg.cc/MG9ZgfNF/3.png)

   e.  用户A出价200000Wei，伪出价为真(假拍 标记为true),密钥为‘ying123’为其生成哈希值 

   f. 将生成的哈希值传递给bid的参数，选择用户A，预存金额300000Wei，执行盲拍方法 

   g.  用户A出价300000Wei，真拍出价(标记为false),密钥为‘link456’为其生成哈希值 

   h. 将生成的哈希值传递给bid的参数，选择用户A，预存金额300000Wei，执行盲拍方法 

   i. 查看映射变量bids，用户A对应索引1 和 2的值
   

至此，完成了任务43合约的调试，部署和测试。
## **🌸 知识测试**  